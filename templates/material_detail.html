{% extends 'base.html' %}

{% block content %}
<div class="material-container">
    <div class="alert alert-success">
        <strong>üéì AI-Adapted Content</strong>
        <p>This content has been personalized for your learning style and needs.</p>
    </div>
    
    <div class="material-header">
        <h1>{{ material.title }}</h1>
        <p class="subject-badge">{{ material.subject }}</p>
        <p class="uploaded-date">Uploaded: {{ material.uploaded_at|date:"M d, Y" }}</p>
    </div>
    
    <!-- Video Section -->
    <div class="video-section">
        <h2>üé¨ Your Personal AI Tutor</h2>
        
        {% if video_status == 'ready' and avatar_video %}
            <!-- Video is ready - show it -->
            <div class="video-container">
                <video id="lesson-video" controls width="100%" controlsList="nodownload">
                    <source src="{{ avatar_video.video_url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                
                <div class="video-info">
                    <p>‚úÖ <strong>Personalization Applied</strong></p>
                    <p>Generated with {{ material.subject }} Teacher Avatar for 
                       {% for style in learning_styles %}{{ style.name }}{% if not forloop.last %}, {% endif %}{% endfor %} learner
                    </p>
                    {% if challenges %}
                    <p>‚ôø Accommodations: 
                       {% for challenge in challenges %}{{ challenge.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </p>
                    {% endif %}
                    <p>‚è± Duration: {{ avatar_video.duration|default:"2-3" }} seconds</p>
                </div>
            </div>
            
        {% elif video_status == 'processing' or video_status == 'generating' %}
            <!-- Video is being generated - show loading with polling -->
            <div id="video-loading" class="loading-container">
                <div class="spinner"></div>
                <h3>üé¨ Generating Your Personal AI Tutor...</h3>
                <p>Please wait while we create your personalized video lesson. This takes about 60-90 seconds.</p>
                <p id="status-message">Creating personalized content...</p>
                <p id="elapsed-time">0 seconds elapsed</p>
                
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
            </div>
            
        {% else %}
            <!-- No video yet -->
            <div class="no-video">
                <p>Video content is being prepared...</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Adapted Text Content -->
    {% if adapted_content %}
    <div class="text-content">
        <h3>üìù Text Version</h3>
        <div class="adapted-text">
            {{ adapted_content.adapted_text|linebreaks }}
        </div>
    </div>
    {% endif %}
    
    <!-- Progress Tracking -->
    <div class="progress-section">
        <h3>üìä Your Progress</h3>
        <p>Completion: <strong>{{ progress.completion_percentage }}%</strong></p>
        <p>Time spent: <strong>{{ progress.time_spent|default:0 }} seconds</strong></p>
        
        <div class="progress-actions">
            <button onclick="markProgress(25)" class="btn btn-progress">+25%</button>
            <button onclick="markProgress(50)" class="btn btn-progress">+50%</button>
            <button onclick="markComplete()" class="btn btn-success">Mark Complete</button>
        </div>
    </div>
</div>

<style>
.loading-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px;
    border-radius: 15px;
    text-align: center;
    margin: 20px 0;
}

.spinner {
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top: 5px solid white;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-bar {
    width: 100%;
    height: 30px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    margin-top: 20px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: white;
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 15px;
}

.video-container {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
}

video {
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.video-info {
    margin-top: 15px;
    padding: 15px;
    background: white;
    border-radius: 8px;
}

.text-content {
    background: white;
    padding: 30px;
    border-radius: 10px;
    margin: 20px 0;
}

.adapted-text {
    line-height: 1.8;
    font-size: 16px;
}
</style>

<script>
// Polling for video status
{% if video_status == 'processing' or video_status == 'generating' %}
let startTime = Date.now();
let pollInterval;
let progressInterval;

function updateElapsedTime() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('elapsed-time').textContent = elapsed + ' seconds elapsed';
    
    // Update progress bar (simulate)
    const progress = Math.min((elapsed / 120) * 100, 95); // Max 95% until actually ready
    document.getElementById('progress-fill').style.width = progress + '%';
}

function checkVideoStatus() {
    fetch('{% url "check_video_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            material_id: {{ material.id }}
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Video status:', data);
        
        document.getElementById('status-message').textContent = data.message;
        
        if (data.status === 'ready') {
            // Video is ready! Reload page to show it
            clearInterval(pollInterval);
            clearInterval(progressInterval);
            document.getElementById('progress-fill').style.width = '100%';
            
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error checking status:', error);
    });
}

// Start polling every 5 seconds
pollInterval = setInterval(checkVideoStatus, 5000);

// Update elapsed time every second
progressInterval = setInterval(updateElapsedTime, 1000);

// Check immediately on load
checkVideoStatus();
updateElapsedTime();
{% endif %}

// Progress tracking functions
function markProgress(percentage) {
    fetch('{% url "update_progress" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            material_id: {{ material.id }},
            completion_percentage: {{ progress.completion_percentage }} + percentage,
            time_spent: 30 // Add 30 seconds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        }
    });
}

function markComplete() {
    fetch('{% url "update_progress" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            material_id: {{ material.id }},
            completion_percentage: 100,
            time_spent: 60
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('üéâ Congratulations! You completed this lesson!');
            window.location.href = '{% url "materials_list" %}';
        }
    });
}

// Track video watch time
{% if avatar_video %}
const video = document.getElementById('lesson-video');
let watchTime = 0;
let lastUpdate = Date.now();

video.addEventListener('play', () => {
    lastUpdate = Date.now();
});

video.addEventListener('pause', () => {
    watchTime += (Date.now() - lastUpdate) / 1000;
    updateWatchTime();
});

video.addEventListener('ended', () => {
    watchTime += (Date.now() - lastUpdate) / 1000;
    updateWatchTime();
    markProgress(100); // Auto-complete when video ends
});

function updateWatchTime() {
    fetch('{% url "update_progress" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            material_id: {{ material.id }},
            completion_percentage: Math.min((watchTime / {{ avatar_video.duration }}) * 100, 100),
            time_spent: Math.floor(watchTime)
        })
    });
}
{% endif %}
</script>

{% endblock %}